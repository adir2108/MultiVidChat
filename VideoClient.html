<!DOCTYPE html>
<html>
<head>
    <title>Video Chat</title>
</head>
<body>

<div style="display:flex; justify-content:center; align-items:center; height:100vh; gap:10px;">
    <video id="localVideo" autoplay muted playsinline style="width:45%; border:1px solid black; background:black;"></video>
    <video id="remoteVideo" autoplay playsinline style="width:45%; border:1px solid black; background:black;"></video>
</div>

<script>
let pc;
let ws;
let localStream;
let isCaller = false;

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

const params = new URLSearchParams(window.location.search);
const username = params.get("username");
const room = params.get("room");

// Connect to WebSocket
ws = new WebSocket(`ws://${window.location.hostname}:8765`);

// Initialize the peer connection and get local stream
async function initConnection() {
    try {
        // Ask for camera and mic
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        // When remote track arrives
        pc.ontrack = (event) => {
            console.log("Remote stream received");
            remoteVideo.srcObject = event.streams[0];
        };

        // Send ICE candidates to server
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                ws.send(JSON.stringify({ action: "ice", candidate: event.candidate }));
            }
        };

        // Add local tracks
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        console.log("Local stream added to PeerConnection");
    } catch (err) {
        console.error("Error accessing camera/mic:", err);
        alert("Cannot access camera/microphone. Make sure you allowed it.");
    }
}

// Caller creates an offer
async function makeCall() {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ action: "offer", offer }));
}

// Callee answers
async function answerCall(offer) {
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ action: "answer", answer }));
}

// WebSocket logic
ws.onopen = () => ws.send(JSON.stringify({ action: "set_user", username, room }));

ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);

    // Always initialize connection first if not already
    if (!pc) await initConnection();

    if (data.action === "set_user_ack") {
        if (data.isCaller) {
            isCaller = true;
            makeCall();
        }
    } else if (data.action === "offer") {
        await answerCall(data.offer);
    } else if (data.action === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    } else if (data.action === "ice") {
        try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (e) {
            console.error("ICE candidate error", e);
        }
    }
};



</script>

</body>
</html>
